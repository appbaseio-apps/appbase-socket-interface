<!doctype html>
<html>

<head>
  <title>Appbase.io + Socket.io</title>

  <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">

  <style>
    #header {
      background-color: #696;
      color: white;
      text-align: center;
      padding: 5px;
    }

    .dashboard {
      width: 95%;
    }

    h2 span,
    h4 span {
      font-size: 16px;
      font-weight: normal;
    }

    .dashboard-post.label {
      float: right;
    }
  </style>

</head>

<body>

  <div id="header">
    <h2>Appbase.io + Socket.io,
      <span>An ACL based content management dashboard</span>
    </h2>
  </div>

  <div class="well" align="center">
    <div class="row">
      <div class="col-md-2">
        <h4>Pick a user role</h4>
      </div>
      <div class="col-md-10">
        <select class="form-control" name="role">
          <option value="admin">admin</option>
          <option value="user">user</option>
          <option value="guest">guest</option>
        </select>
      </div>
    </div>
  </div>

  <div class="container dashboard">
    <div class="row">
      <div class="col-md-4">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4>Submit a new post</h4>
          </div>
          <div class="panel-body">
            <form>
              <div class="form-group">
                <label>Title</label>
                <input id="title" class="form-control" autocomplete="off" />
              </div>
              <div class="form-group">
                <label>Post</label>
                <textarea id="post" class="form-control" rows="6" autocomplete="off" /></textarea>
              </div>
              <div align="center" style="margin-bottom:10px;">
                <button type="submit" class="btn btn-success">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4>Content Dashboard
              <span>(See all posts)</span>
            </h4>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-md-4">
                <p id="approved_subcount"></p>
                <button class="btn btn-info" id="subscribe_approved">Subscribe to Approved Posts</button>
                <p/>
                <p id="pending_subcount"></p>
                <button class="btn btn-info" id="subscribe_pending">Subscribe to Pending Posts</button>
              </div>
              <div class="col-md-8">
                  <ul id="all_posts" class="list-group"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script src="/bower_components/jquery/dist/jquery.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script>
    var socket = io();

    $(document).ready(function() {
      var jsonObject = {
        "role": $("select option:selected").text()
      };

      socket.emit('loggedin', jsonObject);
    });

    $('form').submit(function() {
      var jsonObject = {
        "role": $("select option:selected").text(),
        "title": $('#title').val(),
        "post": $('#post').val()
      };

      socket.emit('on_blog_post', jsonObject);
      $('#title').val('');
      $('#post').val('');
      return false;
    });

    $("#subscribe_approved").click(function() {
      var jsonObject = {
        "role": $("select option:selected").text()
      };

      socket.emit('subscribe_approved', jsonObject);
    });

    $("#subscribe_pending").click(function() {
      var jsonObject = {
        "role": $("select option:selected").text()
      };
      socket.emit('subscribe_pending', jsonObject);
    });

    $("#approve_pending").click(function() {
      var jsonObject = {
        "role": $("select option:selected").text()
      };
      socket.emit('approve_pending', jsonObject);
    });

    $(".approveMe").on("click", function() {
      alert("");
    });

    socket.on('blog_post_approved', function(response) {
      var id = response._id;
      var msg = response._source;
      var text = '{Title:' + msg.title + ', Post: ' + msg.post + '}';

      var li = document.createElement('li');
      li.className = 'list-group-item';
	  li.id = id;
      li.appendChild(document.createTextNode(text));


      var iDiv = document.createElement('span');
      iDiv.className = 'dashboard-post label label-success';

      iDiv.appendChild(document.createTextNode('Approved'));
	  
	  var deleteDiv = document.createElement('span');
      deleteDiv.className = 'dashboard-post label label-danger';
	  deleteDiv.appendChild(document.createTextNode('Delete'));

	  
	  li.appendChild(deleteDiv);
	  li.appendChild(document.createElement('span'));
      li.appendChild(iDiv);
	  
	  $(iDiv).on('click', function() {
        var jsonObject = {
          "role": $("select option:selected").text(),
          "id": id
        };
        socket.emit('move_to_pending', jsonObject);
      });
	  
	  $(deleteDiv).on('click', function() {
        var jsonObject = {
          "role": $("select option:selected").text(),
          "id": id,
		  "type": "approvedpost"
        };
        socket.emit('delete_post', jsonObject);
      });

      $('#all_posts').append(li);

    });

    socket.on('blog_post_created', function(response) {
      var id = response._id;
      var msg = response._source;
      var text = '{Title:' + msg.title + ', Post: ' + msg.post + '}';

      var li = document.createElement('li');
	  li.className = 'list-group-item';
      li.id = id;
      li.appendChild(document.createTextNode(text));


      var iDiv = document.createElement('div');
      iDiv.className = 'dashboard-post label label-warning';
      iDiv.appendChild(document.createTextNode('Pending'));
	  
	  var deleteDiv = document.createElement('span');
      deleteDiv.className = 'dashboard-post label label-danger';
	  deleteDiv.appendChild(document.createTextNode('Delete'));

	  
	  li.appendChild(deleteDiv);
      li.appendChild(document.createElement('span'));
	  li.appendChild(iDiv);

      $(iDiv).on('click', function() {
        var jsonObject = {
          "role": $("select option:selected").text(),
          "id": id
        };
        socket.emit('approve_pending', jsonObject);
      });
	  
	  $(deleteDiv).on('click', function() {
        var jsonObject = {
          "role": $("select option:selected").text(),
          "id": id,
		  "type": "pendingpost"
        };
        socket.emit('delete_post', jsonObject);
      });

      $('#all_posts').append(li);
    });

    socket.on('blog_post_deleted', function(response) {
      var id = response._id;
	  
      $('#' + id).remove();
    });

    socket.on('pending_subscribeCount', function(msg) {
      $('#pending_subcount').text(msg);
    });

    socket.on('approved_subscribeCount', function(msg) {
      $('#approved_subcount').text(msg);
    });

    socket.on('failure', function(msg) {
      alert(msg);
    });

    socket.on('success', function(msg) {
      alert(msg);
    });
  </script>
</body>

</html>
